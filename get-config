#!/usr/bin/env bash
# Gets a script config or lists all configs

# Environment setup
# -----------------------------------------------------------------------------
set -o pipefail # set -o errexit hides errors, don't use it
[[ ${DEBUG-} ]] && set -o xtrace
SCRIPT_DIR="$(cd "${BASH_SOURCE[0]%/*}" || exit 1; pwd)"
[[ ":${PATH}:" != *:${SCRIPT_DIR}:* ]] && export PATH="${SCRIPT_DIR}:${PATH}"
source "${SCRIPT_DIR}/bash_modules/terminal.sh"
source "${SCRIPT_DIR}/bash_modules/config.sh"
source "${SCRIPT_DIR}/bash_modules/utils.sh"
[[ -z ${BASH_MODULES_DIR-} ]] && echo "ERROR: terminal.sh module missing" && exit 1

function print_usage() {
  cat <<EOF
Usage: $(basename "$0") [key]

Lists all script configs or returns a specific key/value pair.

Dependencies:
  rg                 RipGrep recursively searches directories for a regex pattern

Optional arguments:
  key                The specific config key to retrieve
  -h, --help         Show this help message and exit
EOF
}

if [[ $# -gt 1 || "${1}" == "-h" || "${1}" == "--help" ]]; then
  print_usage
  exit 1
fi

# Dependency Checks
# -----------------------------------------------------------------------------
dependencies=(rg)
for cmd in "${dependencies[@]}"; do
  if ! command -v "${cmd}" >/dev/null; then
    log_error "ERROR: Missing dependency - '${cmd}'"
    exit 1
  fi
done

# Main Logic
# -----------------------------------------------------------------------------
log_title "Get Script Config"
log_message "Source: $(config_get_path)"

# If no argument provided, list all configs
if [[ -z "${1}" ]]; then
  log_heading "Default Configuration"
  log_message "Source: $(config_get_defaults_path)"
  config_list_defaults
  log_newline

  log_heading "User Configuration"
  log_message "Source: $(config_get_path)"
  config_list
  exit 0
fi

# Validate that key is not empty or whitespace-only
if [[ -z "${1// /}" ]]; then
  log_error "ERROR: Key argument cannot be empty or whitespace-only"
  print_usage
  exit 1
fi

# Get the value for the specified key
declare key="${1}"
declare value
value="$(config_get "${key}")"

if [[ -n "${value}" ]]; then
  log_newline
  printf '%s="%s"\n' "$(to_upper "${key}")" "${value}"
  exit 0
fi

log_error "Key '$(to_upper "${key}")' not found in config"
exit 1