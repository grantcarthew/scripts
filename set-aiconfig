#!/usr/bin/env bash
# Configure AI model settings for claude/gemini/aichat services

# AI Model Configuration Script
# -----------------------------------------------------------------------------
# Interactive script to configure AI model settings for claude/gemini/aichat.
# Models are stored in the settings system for use by the ai.sh module.

# Environment setup
# -----------------------------------------------------------------------------
set -o pipefail
[[ ${DEBUG-} ]] && set -o xtrace
SCRIPT_DIR="$(cd "${BASH_SOURCE[0]%/*}" || exit 1; pwd)"
[[ ":${PATH}:" != ":${SCRIPT_DIR}:" ]] && export PATH="${SCRIPT_DIR}:${PATH}"
source "${SCRIPT_DIR}/bash_modules/terminal.sh"
[[ -z ${BASH_MODULES_DIR-} ]] && echo "ERROR: terminal.sh module missing" && exit 1
source "${SCRIPT_DIR}/bash_modules/config.sh"

function print_usage() {
  cat <<EOF
Usage: $(basename "$0")

Interactive configuration script for AI model settings.
Configures models for claude, gemini, and aichat services and fast/mid/pro tiers.

Dependencies:
  rg                 RipGrep for settings file management

Options:
  -h, --help         Show this help message and exit
EOF
}
if [[ "${1-}" == "-h" || "${1-}" == "--help" ]]; then
  print_usage
  exit 0
fi

function ctrlc_trap() {
  log_newline
  log_warning "Script interrupted. Exiting."
  exit 130
}
trap ctrlc_trap SIGINT

function validate_model() {
  local service="${1}"
  local model="${2}"

  case "${service}" in
    claude)
      if [[ ! "${model}" =~ ^claude- ]]; then
        log_warning "Model '${model}' doesn't look like a Claude model"
        return 1
      fi
      ;; 
    gemini)
      if [[ ! "${model}" =~ ^gemini- ]]; then
        log_warning "Model '${model}' doesn't look like a Gemini model"
        return 1
      fi
      ;; 
    aichat)
      if [[ ! "${model}" =~ ^vertexai: ]]; then
        log_warning "Model '${model}' doesn't look like an aichat model (should start with 'vertexai:')"
        return 1
      fi
      ;; 
  esac
  return 0
}

# Title and Dependency Checks
# -----------------------------------------------------------------------------
log_title "AI Model Configuration"

dependencies=(rg)
for cmd in "${dependencies[@]}"; do
  if ! command -v "${cmd}" >/dev/null; then
    log_error "ERROR: Missing dependency - '${cmd}'"
    exit 1
  fi
done

# Main Logic
# -----------------------------------------------------------------------------
log_heading "Current Configuration"

for service in claude gemini aichat; do
  for tier in fast mid pro; do
    key="AI_${service^^}_${tier^^}"
    model="$(config_get "${key}")"
    printf "% -15s: %s\n" "${service} ${tier}" "${model:-<not set>}" >&2
  done
done
log_newline
log_heading "Service Selection"
log_message "Select service:"
echo "1) claude" >&2
echo "2) gemini" >&2
echo "3) aichat" >&2
read -p "Choice [1-3]: " service_choice

service=""
case "${service_choice}" in
  1) service="claude" ;;
  2) service="gemini" ;;
  3) service="aichat" ;;
  *) log_error "Invalid choice"; exit 1 ;;
esac

log_heading "Model Tier Selection"
log_message "Select model tier:"
echo "1) fast" >&2
echo "2) mid" >&2
echo "3) pro" >&2
read -p "Choice [1-3]: " tier_choice

tier=""
case "${tier_choice}" in
  1) tier="fast" ;;
  2) tier="mid" ;;
  3) tier="pro" ;;
  *) log_error "Invalid choice"; exit 1 ;;
esac

# Get current value
key="AI_${service^^}_${tier^^}"
current="$(config_get "${key}")"

log_heading "Model Configuration"
log_message "Configuring: ${service} ${tier}"
log_message "Current value: ${current:-<not set>}"
log_newline

# Get new model
read -p "Enter new model string: " new_model

if [[ -z "${new_model}" ]]; then
  log_error "Model cannot be empty"
  exit 1
fi

# Validate and save
if validate_model "${service}" "${new_model}"; then
  config_set "${key}" "${new_model}"
  log_success "Saved: ${key}=${new_model}"
else
  log_newline
  read -p "Save anyway? [y/N]: " confirm
  if [[ "${confirm}" =~ ^[Yy] ]]; then
    config_set "${key}" "${new_model}"
    log_success "Saved: ${key}=${new_model}"
  else
    log_warning "Configuration cancelled"
  fi
fi